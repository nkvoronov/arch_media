pkgname="tbsdtv-git"
_gitname='source-git'
_gitname2='source-git2'
pkgver=r1508.87e83e0_5.15.41_1_MANJARO
pkgrel=1
pkgdesc="TBS linux open source drivers"
arch=('x86_64')
url="https://github.com/tbsdtv/linux_media"
license=('GPL2')
depends=('tbsdtv-firmware')
makedepends=('git' 'linux-headers' 'patchutils' 'perl-proc-processtable')
provides=("tbsdtv")
install='tbsdtv-git.install'
conflicts=('tbs-linux_media-git')
source=("${_gitname}::git+https://github.com/tbsdtv/media_build.git#branch=extra"
        "${_gitname2}::git+https://github.com/tbsdtv/linux_media.git#branch=latest"
        'add-to-backports.patch'
        'si2157.c'
        'tbsdtv-git.install')
md5sums=('SKIP'
         'SKIP'
         '75c97605c594acfbb89bc153b6a6801c'
         '9fe6e6db24f5198c4439388d0a7a9c46'
         'c9c28c82101eb4a3363e34f95bda6d21')

prepare() {
  cd "${srcdir}/${_gitname}"
  cp -PR ../../backports/* backports/
  for f in "$srcdir"/*.patch; do patch -p1 < "$f"; done

  #cd "${srcdir}/${_gitname2}"
  #echo '** SI2157 **'
  #cp -P ../../si2157.c drivers/media/tuners/
}

pkgver() {
  cd "${srcdir}/${_gitname}"
  _gitver=$(printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)")
  _kernel=$(uname -r | sed -r 's/-/_/g')
  echo "$_gitver"_"$_kernel"
}

build() {
  cd "${srcdir}/${_gitname}"

  make dir DIR=../${_gitname2}
# make allyesconfig
  make distclean
  make
}

package() {
  cd "${srcdir}/${_gitname}"
  _emkernel=$(uname -r | sed -r 's/.41-1//g')
  mkdir -p "$pkgdir"/usr/lib/modules/extramodules-"${_emkernel}"/tbs
  find "$srcdir/$_gitname" -name '*.ko' -exec cp "{}" "$pkgdir"/usr/lib/modules/extramodules-"${_emkernel}"/tbs \;
  msg "Compressing modules, this will take awhile..."
  find "$pkgdir" -name '*.ko' -print0 | xargs -0 -P"$(nproc)" -n10 gzip -9
  chmod 0644 "$pkgdir"/usr/lib/modules/extramodules-"${_emkernel}"/tbs/*.ko.gz
}
