# Maintainer:         Alexander Blinne "Sunday" <alexander at blinne dot net>
# Original Submitter: Wessel Dirksen "p-we" <wdirksen at gmail dot com>

pkgname=tbs-linux-drivers-cc-git
_gitname='tbs-linux-drivers-cc'
_branch=v161031-patch
pkgver=98955fa_4.12.13_1_ARCH
pkgrel=1
pkgdesc="TBS proprietary DVB drivers + firmware CrazyCat"
url="http://www.tbsdtv.com"
arch=('i686' 'x86_64')
license=('GPL')
makedepends=('linux-headers' 'wget' 'moreutils' 'coreutils' 'perl-proc-processtable')
optdepends=('linuxtv-dvb-apps: handy DVB tools' 'v4l-utils: hardware support for some cards')
conflicts=('ffdecsawrapper' 'tbs-linux-drivers' 'tbs-dvb-drivers' 'media-build-git')
provides=('tbs-linux-drivers-cc')
install='tbs-linux-drivers-cc.install'

source=("${_gitname}::git+https://github.com/nkvoronov/tbs-linux-drivers-cc.git#branch=${_branch}"
        'tbs-linux-drivers-cc.install')

md5sums=('SKIP'
         '59f8329e80cbcb94235eda483983efc8')

pkgver() {
  cd "${srcdir}/${_gitname}"
  _git=`git rev-parse --short HEAD`
  _kernel=`uname -r | sed -r 's/-/_/g'`
  printf "%s_%s" "$_git" "$_kernel"
}

build() {
  cd "${srcdir}/${_gitname}"
  make distclean
  if [ `uname -m` == "x86_64" ]; then
    ./v4l/tbs-x86_64.sh
  else
    ./v4l/tbs-x86_r3.sh
  fi
  if [ -z "$_kernel" ]
  then
    _kernel=`uname -r`
  fi
  make -j4
}

package() {
  mkdir -p $pkgdir/usr/lib/modules/`uname -r`/updates/tbs
  mkdir -p $pkgdir/usr/lib/firmware
  install -m0644 ${srcdir}/${_gitname}/v4l/firmware/*.fw  $pkgdir/usr/lib/firmware
  find ${srcdir}/${_gitname} -name '*.ko' -exec cp {} $pkgdir/usr/lib/modules/`uname -r`/updates/tbs \;
  echo ""
  msg "Compressing modules, this will take awhile..."
  echo ""
  find "$pkgdir" -name '*.ko' -print0 | xargs -0 -P`nproc` -n10 gzip -9
  chmod -R go-w $pkgdir/usr/lib/modules/`uname -r`/updates
}
